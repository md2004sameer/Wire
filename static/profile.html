<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Profile Â· Wire</title>

  <style>
    body {
      background:#020617;
      color:#e5e7eb;
      font-family:system-ui, sans-serif;
      margin:0;
      padding:24px;
    }

    .container {
      max-width:640px;
      margin:0 auto;
    }

    .header {
      display:flex;
      gap:20px;
      align-items:center;
      margin-bottom:24px;
    }

    .avatar {
      width:96px;
      height:96px;
      border-radius:50%;
      background:#2563eb;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:40px;
      font-weight:700;
    }

    .username {
      font-size:20px;
      font-weight:700;
    }

    .bio {
      margin-top:6px;
      color:#cbd5e1;
      font-size:14px;
    }

    .stats {
      display:flex;
      gap:24px;
      margin-top:14px;
    }

    .stat { cursor:pointer; }

    .section {
      border-top:1px solid #1e293b;
      padding-top:20px;
      margin-top:24px;
    }

    label {
      font-size:12px;
      color:#94a3b8;
      display:block;
      margin-top:12px;
    }

    input, textarea {
      width:100%;
      margin-top:6px;
      padding:10px;
      background:#020617;
      color:#e5e7eb;
      border:1px solid #334155;
      border-radius:8px;
    }

    textarea { resize:none; min-height:80px; }

    .actions {
      display:flex;
      justify-content:space-between;
      margin-top:28px;
    }

    button {
      padding:10px 18px;
      border-radius:8px;
      border:none;
      font-weight:600;
      cursor:pointer;
    }

    .primary { background:#2563eb; color:white; }
    .secondary { background:#334155; color:white; }

    .hidden { display:none; }
  </style>
</head>

<body>
<div class="container">

  <!-- HEADER -->
  <div class="header">
    <div class="avatar" id="avatar">U</div>
    <div>
      <div class="username" id="username"></div>
      <div class="bio" id="bioText"></div>

      <div class="stats">
        <div class="stat" onclick="goToFriends('followers')">
          <strong id="followersCount">0</strong> Followers
        </div>
        <div class="stat" onclick="goToFriends('following')">
          <strong id="followingCount">0</strong> Following
        </div>
      </div>
    </div>
  </div>

  <!-- EDITABLE SECTION -->
  <div class="section">
    <label>Bio</label>
    <textarea id="bioInput" readonly></textarea>

    <label>Website</label>
    <input id="website" readonly>

    <label>Location</label>
    <input id="location" readonly>

    <label>
      <input type="checkbox" id="is_private" disabled> Private profile
    </label>
  </div>

  <!-- ACTIONS -->
  <div class="actions">
    <button class="secondary" onclick="logout()">Logout</button>

    <div>
      <button id="editBtn" class="primary" onclick="enableEdit()">Edit</button>
      <button id="saveBtn" class="primary hidden" onclick="saveProfile()">Save</button>
    </div>
  </div>

</div>

<script>
/* ---------- AUTH GUARD ---------- */
(async function () {
  const res = await fetch("/auth/me", { credentials: "include" });
  if (res.status === 401) location.replace("/login");
})();

/* ---------- REDIRECT ---------- */
function goToFriends(type) {
  location.href = `/friends-list?type=${type}`;
}

/* ---------- LOAD PROFILE ---------- */
async function loadProfile() {
  const res = await fetch("/profile/me", { credentials: "include" });
  if (!res.ok) return;

  const p = await res.json();

  username.innerText = p.username;
  bioText.innerText = p.bio || "No bio yet";

  bioInput.value = p.bio || "";
  website.value = p.website || "";
  location.value = p.location || "";
  is_private.checked = p.is_private;

  avatar.innerText = p.username[0].toUpperCase();
}

/* ---------- LOAD COUNTS ---------- */
async function loadCounts() {
  const followers = await fetch("/friends/followers", { credentials:"include" }).then(r=>r.json());
  const following = await fetch("/friends/following", { credentials:"include" }).then(r=>r.json());

  followersCount.innerText = followers.count;
  followingCount.innerText = following.count;
}

/* ---------- EDIT MODE ---------- */
function enableEdit() {
  document.querySelectorAll("input, textarea").forEach(el => {
    if (el.type === "checkbox") el.disabled = false;
    else el.readOnly = false;
  });

  editBtn.classList.add("hidden");
  saveBtn.classList.remove("hidden");
}

/* ---------- SAVE PROFILE ---------- */
async function saveProfile() {
  const payload = {
    bio: bioInput.value,
    website: website.value,
    location: location.value,
    is_private: is_private.checked
  };

  await fetch("/profile/me", {
    method: "PUT",
    credentials: "include",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  });

  editBtn.classList.remove("hidden");
  saveBtn.classList.add("hidden");

  document.querySelectorAll("input, textarea").forEach(el => {
    if (el.type === "checkbox") el.disabled = true;
    else el.readOnly = true;
  });

  loadProfile();
}

/* ---------- LOGOUT ---------- */
async function logout() {
  await fetch("/auth/logout", { method:"POST", credentials:"include" });
  location.replace("/login");
}

loadProfile();
loadCounts();
</script>
</body>
</html>
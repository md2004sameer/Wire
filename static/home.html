<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Wire · Home</title>
  <link rel="stylesheet" href="/static/css/theme.css">
  <style>
/* ========== LAYOUT ========== */
body {
  background:#020617;
  color:#e5e7eb;
  font-family: system-ui, sans-serif;
  margin:0;
}

.container {
  max-width:600px;
  margin:0 auto;
  min-height:100vh;
  display:flex;
  flex-direction:column;
}

/* ========== TOP BAR ========== */
.topbar {
  position:sticky;
  top:0;
  background:#020617;
  border-bottom:1px solid #1e293b;
  padding:12px 16px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  z-index:10;
}

.topbar h3 {
  margin:0;
  font-size:20px;
  font-weight:600;
}

/* ========== PROFILE AVATAR ========== */
.profile-avatar {
  width:36px;
  height:36px;
  border-radius:50%;
  background:#2563eb;
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
}

.profile-avatar span {
  color:white;
  font-weight:700;
}

/* ========== COMPOSER ========== */
.composer {
  padding:12px;
  border-bottom:1px solid #1e293b;
  display:flex;
  flex-direction:column;
  gap:8px;
}

.composer textarea {
  width:100%;
  min-height:80px;
  resize:none;
  background:#020617;
  color:#e5e7eb;
  border:1px solid #334155;
  border-radius:10px;
  padding:10px;
  outline:none;
}

.composer textarea::placeholder {
  color:#94a3b8;
}

.composer button {
  align-self:flex-end;
  padding:8px 16px;
  background:#2563eb;
  border:none;
  border-radius:8px;
  color:white;
  font-weight:600;
  cursor:pointer;
}

.composer button:hover {
  background:#1d4ed8;
}

/* ========== FEED ========== */
#feed {
  display:flex;
  flex-direction:column;
}

/* ========== POST ========== */
.post {
  padding:12px;
  border-bottom:1px solid #1e293b;
}

.author {
  font-weight:600;
  margin-bottom:6px;
  color:#f8fafc;
}

.post-content {
  color:#cbd5f5;
  line-height:1.5;
}
</style>
</head>

<body>

<script>
const token = localStorage.getItem("access_token");
if (!token) {
  location.replace("/login");
}

/* ---------------- LOAD AVATAR (SAFE) ---------------- */

async function loadAvatar() {
  try {
    const res = await fetch("/profile/me", {
      headers: { Authorization: "Bearer " + token }
    });

    // ❌ REAL logout case
    if (res.status === 401 || res.status === 403) {
      localStorage.removeItem("access_token");
      location.replace("/login");
      return;
    }

    // ✅ Profile not created yet — NORMAL
    if (res.status === 404) {
      document.getElementById("avatar-letter").innerText = "U";
      return;
    }

    if (!res.ok) return;

    const p = await res.json();
    document.getElementById("avatar-letter").innerText =
      (p.full_name || "U")[0].toUpperCase();

  } catch {
    // network errors ignored on home page
  }
}

/* ---------------- NAVIGATION ---------------- */

function goToProfile() {
  location.href = "/profile";
}

loadAvatar();
</script>

<div class="container">

  <div class="topbar">
    <h3>Wire</h3>
    <div class="profile-avatar" onclick="goToProfile()">
      <span id="avatar-letter">Q</span>
    </div>
  </div>
    <script>
async function loadAvatarLetter() {
  try {
    const res = await fetch("/auth/me", {
      credentials: "include"
    });

    if (res.status === 401) {
      location.href = "/login";
      return;
    }

    const user = await res.json();
    const letter = user.username?.[0]?.toUpperCase() || "U";
    document.getElementById("avatar-letter").innerText = letter;

  } catch {
    // silent fail, keep default U
  }
}

loadAvatarLetter();
</script>

  <div class="composer">
    <textarea id="content" placeholder="What's happening?"></textarea>
    <button onclick="createPost()">Post</button>
  </div>

  <div id="feed"></div>

</div>

<script src="/static/js/feed.js"></script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Explore Users Â· Wire</title>

  <style>
    body {
      background:#020617;
      color:#e5e7eb;
      font-family:system-ui, sans-serif;
      padding:20px;
    }

    .container {
      max-width:600px;
      margin:0 auto;
    }

    h2 {
      margin-bottom:12px;
    }

    input {
      width:100%;
      padding:10px;
      border-radius:6px;
      border:1px solid #334155;
      background:#020617;
      color:white;
      margin-bottom:12px;
    }

    ul {
      list-style:none;
      padding:0;
      margin:0;
    }

    li {
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:12px 8px;
      border-bottom:1px solid #334155;
    }

    .user-info {
      display:flex;
      flex-direction:column;
    }

    .private {
      font-size:12px;
      color:#94a3b8;
    }

    button {
      padding:6px 12px;
      border-radius:999px;
      border:none;
      cursor:pointer;
      background:#2563eb;
      color:white;
      font-size:13px;
      font-weight:600;
    }

    button.secondary {
      background:#475569;
    }

    button:disabled {
      background:#334155;
      cursor:not-allowed;
    }

    .empty {
      text-align:center;
      color:#94a3b8;
      padding:40px;
    }
  </style>
</head>

<body>
<div class="container">
  <h2>Explore Users</h2>
  <input id="search" placeholder="Search usersâ€¦" />
  <ul id="users"></ul>
</div>

<script>
/* =========================
   AUTH GUARD
   ========================= */
(async function authGuard() {
  const res = await fetch("/auth/me", { credentials: "include" });
  if (res.status === 401) location.replace("/login");
})();

/* =========================
   STATE
   ========================= */
let skip = 0;
const limit = 10;
let loading = false;
let finished = false;
let query = "";

const usersEl = document.getElementById("users");
const searchEl = document.getElementById("search");

/* =========================
   FETCH USERS
   ========================= */
async function fetchUsers(reset = false) {
  if (loading || finished) return;
  loading = true;

  if (reset) {
    skip = 0;
    finished = false;
    usersEl.innerHTML = "";
  }

  const res = await fetch(
    `/friends/users?q=${encodeURIComponent(query)}&skip=${skip}&limit=${limit}`,
    { credentials: "include" }
  );

  if (!res.ok) {
    loading = false;
    return;
  }

  const users = await res.json();
  if (users.length === 0) {
    finished = true;
    loading = false;
    return;
  }

  const usernames = users.map(u => u.username);

  // ðŸ”¥ batch status fetch (FIX)
  const statusRes = await fetch("/friends/status/batch", {
    method: "POST",
    credentials: "include",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(usernames)
  });

  const statusMap = statusRes.ok ? await statusRes.json() : {};

  users.forEach(u => renderUser(u, statusMap[u.username] || "none"));

  skip += limit;
  loading = false;
}

/* =========================
   RENDER USER
   ========================= */
function renderUser(user, status) {
  const li = document.createElement("li");

  const info = document.createElement("div");
  info.className = "user-info";
  info.innerHTML = `
    <strong>${user.username}</strong>
    ${user.is_private ? `<span class="private">Private</span>` : ""}
  `;

  const btn = document.createElement("button");

  applyButtonState(btn, user.username, status);

  li.appendChild(info);
  li.appendChild(btn);
  usersEl.appendChild(li);
}

/* =========================
   BUTTON STATE
   ========================= */
function applyButtonState(btn, username, status) {
  btn.className = "";
  btn.disabled = false;
  btn.onclick = null;

  if (status === "none") {
    btn.textContent = "Follow";
    btn.onclick = () => follow(btn, username);
  }
  else if (status === "pending" || status === "incoming_request") {
    btn.textContent = "Requested";
    btn.classList.add("secondary");
    btn.disabled = true;
  }
  else if (status === "following") {
    btn.textContent = "Following âœ“";
    btn.classList.add("secondary");
    btn.onclick = () => unfollow(btn, username);
  }
  else {
    btn.textContent = status;
    btn.disabled = true;
  }
}

/* =========================
   FOLLOW
   ========================= */
async function follow(btn, username) {
  btn.disabled = true;
  btn.textContent = "Sendingâ€¦";

  const res = await fetch("/friends/follow", {
    method: "POST",
    credentials: "include",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ username })
  });

  if (!res.ok) {
    applyButtonState(btn, username, "none");
    return;
  }

  const data = await res.json();
  applyButtonState(btn, username, data.status);
}

/* =========================
   UNFOLLOW
   ========================= */
async function unfollow(btn, username) {
  btn.disabled = true;

  await fetch("/friends/unfollow", {
    method: "POST",
    credentials: "include",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ username })
  });

  applyButtonState(btn, username, "none");
}

/* =========================
   SEARCH
   ========================= */
searchEl.addEventListener("input", () => {
  query = searchEl.value.trim();
  fetchUsers(true);
});

/* =========================
   INFINITE SCROLL
   ========================= */
window.addEventListener("scroll", () => {
  if (
    window.innerHeight + window.scrollY >=
    document.body.offsetHeight - 200
  ) {
    fetchUsers();
  }
});

/* =========================
   INIT
   ========================= */
fetchUsers();
</script>
</body>
</html>